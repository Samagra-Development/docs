<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.50">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-129291740-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-129291740-2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-129291740-2",{})</script>

<title data-react-helmet="true">PSQL Replication | My Site</title>

<meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="PSQL Replication | My Site"><meta data-react-helmet="true" name="description" content="# Setting up Master Slave Replication in PostgreSQL (upto version 11) using Dockers and external volumes:"><meta data-react-helmet="true" property="og:description" content="# Setting up Master Slave Replication in PostgreSQL (upto version 11) using Dockers and external volumes:"><meta data-react-helmet="true" property="og:url" content="https://Samagra-Development.github.io/docs/docs/docs/PSQLReplication">

<link data-react-helmet="true" rel="shortcut icon" href="/docs/img/favicon.png">


<link rel="stylesheet" href="/docs/styles.dd38a814.css">


<link rel="preload" href="/docs/styles.1167a1dc.js" as="script">

<link rel="preload" href="/docs/runtime~main.26a0ac09.js" as="script">

<link rel="preload" href="/docs/main.02026a88.js" as="script">

<link rel="preload" href="/docs/1.66947721.js" as="script">

<link rel="preload" href="/docs/2.685e1460.js" as="script">

<link rel="preload" href="/docs/3.a41b11c8.js" as="script">

<link rel="preload" href="/docs/1be78505.8b70ae36.js" as="script">

<link rel="preload" href="/docs/64f9f2ab.c376201c.js" as="script">

<link rel="preload" href="/docs/17896441.15136d0f.js" as="script">

<link rel="preload" href="/docs/3db494a0.c9040c91.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/docs/"></a><a target="_self" rel="noopener noreferrer" href="https://tech.samagragovernance.in/" class="navbar__item navbar__link">Tech@Samagra</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/docs/ComponentsOverview">Docs</a><a class="navbar__item navbar__link" href="/docs/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a target="_blank" rel="noopener noreferrer" href="https://Samagra-Development.github.io/docs" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/docs/"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a target="_self" rel="noopener noreferrer" href="https://tech.samagragovernance.in/" class="menu__link">Tech@Samagra</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/docs/ComponentsOverview">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/blog">Blog</a></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" href="https://Samagra-Development.github.io/docs" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Products</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Samiksha</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/SamikshaFuncSpecs">Samiksha FuncSpecs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/deploysamiksha">Deploy Samiksha</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Samwad</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/SamwadFuncSpecs">Samwad FuncSpecs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/deploysamwad">Deploy Samwad</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Pariksha</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/ParikshaFuncSpecs">Pariksha FuncSpecs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/deploypariksha">Deploy Pariksha</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Components</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/ComponentsOverview">Overview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Mobile Application</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/COMobileApplication">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/GettingStartedMobileComponent">Build Your App</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/FormManagementModule">Form Management Module</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/AncillaryScreensModule">Ancillary Screens Module</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/AndroidProfileManagementModule">Profile Screens Module</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/CascadingSearchModule">Cascading Dropdowns Module</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/NotificationModule">Notifications Module</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/OfflineHandlingModule">Offline Handling Module</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/Grove">App Logging</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/CommunicatingAmongModules">Communicating Among Modules</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Application Control</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/COAppControl">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/AppControlPanel">Application Control Console</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/UserManagement">User Management</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/UserAuthentication">User Authentication</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/UserAuthorisation">User Authorisation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/AppDataManagement">Application Data Management</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/AppConfig">Application Config Management</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/AdminSidebarConfig">Sidebar Config</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/AdminAddingMultipleLanguages">Adding Multiple Languages</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/AdminAddingCustomRoutes">Custom Routes</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Database Management</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/CODatabaseManagement">Overview</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">PostgreSQL</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/PSQLOverview">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/dSmall">dSmall</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/dMedium">dMedium</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/pSmall">pSmall</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/pMedium">pMedium</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/pLarge">pLarge</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/docs/PSQLReplication">PSQL Replication</a></li></ul></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Data Analytics</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/CODataAnalytics">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/DataVisualization">Data Visualization</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">PDF Generator</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/COPDFGenerator">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/GoogleDoc2PDF">Google Docs to PDF</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/FormResponses2PDF">Form Response to PDF (alpha)</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/HTML2PDF">HTML Pages to PDF</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/PDFBuildAPlugin">Building A Plugin</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/PDFModuleArchitecture">Architecture</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Conversations &amp; Alerts</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/COConversations">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/CommunicationAdapter">Conversation Channel Adapters</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/CommunicationTransformer">Transformer</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/docs/CommunicationOrchestrator">Logic Manager</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs/XMessageSpec">XMessage Specification</a></li></ul></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">PSQL Replication</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="setting-up-master-slave-replication-in-postgresql-upto-version-11-using-dockers-and-external-volumes"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#setting-up-master-slave-replication-in-postgresql-upto-version-11-using-dockers-and-external-volumes" title="Direct link to heading">#</a>Setting up Master Slave Replication in PostgreSQL (upto version 11) using Dockers and external volumes:</h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="understanding-replication-in-postgresql-upto-version-11"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#understanding-replication-in-postgresql-upto-version-11" title="Direct link to heading">#</a>Understanding replication in PostgreSQL (upto version 11)</h2><p>Streaming replication in PostgreSQL works on log shipping. Every transaction in postgres is written to a transaction log called WAL (write-ahead log) to achieve durability. A slave uses these WAL segments to continuously replicate changes from its master.</p><p>There exists three mandatory processes – wal sender , wal receiver and startup process, these play a major role in achieving streaming replication in postgres.</p><p>A wal sender process runs on a master, whereas the wal receiver and startup processes runs on its slave. When you start the replication, a wal receiver process sends the LSN (Log Sequence Number) up until when the WAL data has been replayed on a slave, to the master. And then the wal sender process on master sends the WAL data until the latest LSN starting from the LSN sent by the wal receiver, to the slave. Wal receiver writes the WAL data sent by wal sender to WAL segments. It is the startup process on slave that replays the data written to WAL segment. And then the streaming replication begins.</p><p>Note: Log Sequence Number, or LSN, is a pointer to a location in the WAL.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="firewall--"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#firewall--" title="Direct link to heading">#</a>Firewall -</h2><p>UFW or Uncomplicated Firewall is an application to manage the iptables based firewall on Ubuntu. UFW is the default firewall configuration tool for Ubuntu Linux and provides a user-friendly way to configure the firewall.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apt-get install -y ufw</span></div></div></div></div></div><p>Add new services to the UFW firewall: add SSH and PostgreSQL services with commands below.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow ssh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow postgresql</span></div></div></div></div></div><p>Enable the UFW firewall and check the status.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ufw enable</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ufw status</span></div></div></div></div></div><p>UFW firewall has been installed and the PostgreSQL service has been added.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="setting-up-docker-using-external-volume"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#setting-up-docker-using-external-volume" title="Direct link to heading">#</a>Setting up Docker using external volume</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="install-docker"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#install-docker" title="Direct link to heading">#</a>Install docker</h3><p>You can install docker from your default package manager or using some other service like <a href="https://snapcraft.io/"><strong>Snapcraft</strong></a> e.g. <code>snap install docker</code></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="setup-docker-engine"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#setup-docker-engine" title="Direct link to heading">#</a>Setup Docker engine</h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="pull-postgress-in-docker"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pull-postgress-in-docker" title="Direct link to heading">#</a>Pull postgress in docker</h4><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker pull postgres</span></div></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="create-docker"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#create-docker" title="Direct link to heading">#</a>Create docker</h4><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker run --name DOCKER_NAME -e POSTGRES_PASSWORD=PASSWORD -d -p 0.0.0.0:5432:5432 -v /mnt/EXTERNAL_VOLUME_NAME/postgres:/var/lib/postgresql/data  postgres</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="check-for-running-dockers"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-for-running-dockers" title="Direct link to heading">#</a>Check for running dockers</h3><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker ps</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="view-all-available-dockers"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#view-all-available-dockers" title="Direct link to heading">#</a>View all available dockers</h3><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker ps -a</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="enter-into-docker-shel"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#enter-into-docker-shel" title="Direct link to heading">#</a>Enter into Docker shel</h3><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker exec -it DOCKER_NAME /bin/bash</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="master--"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#master--" title="Direct link to heading">#</a>Master -</h2><p>Create a role dedicated to the replication - Create the user in master using whichever slave should connect for streaming the WALs. This user must have REPLICATION ROLE.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE USER replica REPLICATION LOGIN ENCRYPTED PASSWORD &#x27;aqwe123@&#x27;;</span></div></div></div></div></div><p>Now check the new user with &#x27;du&#x27; query below, and you will see the replica user with replication privileges.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">\du</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="edit-postgresqlconf--"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#edit-postgresqlconf--" title="Direct link to heading">#</a>Edit postgresql.conf -</h3><p>Note - the postgresql.conf would be present in the following location in case of external volume <code>/mnt/EXTERNAL_VOLUME_NAME/postgres/postgresql.conf</code></p><p>The following parameters on the master are considered as mandatory when setting up streaming replication.</p><ul><li><strong>archive_mode</strong> : Must be set to ON to enable archiving of WALs.</li><li><strong>wal_level</strong> : Must be at least set to hot_standby  until version 9.5 or replica  in the later versions.</li><li><strong>max_wal_senders</strong> : Must be set to 3 if you are starting with one slave. For every slave, you may add 2 wal senders.</li><li><strong>wal_keep_segments</strong> : Set the WAL retention in pg_xlog (until PostgreSQL 9.x) and pg_wal (from PostgreSQL 10). Every WAL requires 16MB of space unless you have explicitly modified the WAL segment size. You may start with 100 or more depending on the space and the amount of WAL that could be generated during a backup.</li><li><strong>archive_command</strong> : This parameter takes a shell command or external programs. It can be a simple copy command to copy the WAL segments to another location or a script that has the logic to archive the WALs to S3 or a remote backup server.</li><li><strong>listen_addresses</strong> : Set it to * or the range of IP Addresses that need to be whitelisted to connect to your master PostgreSQL server. Your slave IP should be whitelisted too, else, the slave cannot connect to the master to replicate/replay WALs.</li><li><strong>hot_standby</strong> : Must be set to ON on standby/replica and has no effect on the master. However, when you setup your replication, parameters set on the master are automatically copied. This parameter is important to enable READS on slave. Otherwise, you cannot run your SELECT queries against slave.</li></ul><p>The above parameters can be set on the master using these commands followed by a restart:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">wal_level = replica</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">max_wal_senders = 3 # max number of walsender processes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">wal_keep_segments = 64 # in logfile segments, 16MB each; 0 disables</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">listen_addresses = &#x27;*&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># or listen_address = ‘IP_OF_SERVER’</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">archive_mode = on</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">archive_command = &#x27;cp %p /var/lib/postgresql/9.6/main/archive/%f&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">synchronous_commit = local</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">synchronous_standby_names = &#x27;pgslave001&#x27;</span></div></div></div></div></div><p>In the postgresql.conf file, the archive mode is enabled, so we need to create a new directory for the archive. Create a new archive directory, change the permission and change the owner to the postgres user.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkdir -p /var/lib/postgresql/9.6/main/archive/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chmod 700 /var/lib/postgresql/9.6/main/archive/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chown -R postgres:postgres /var/lib/postgresql/9.6/main/archive/</span></div></div></div></div></div><p>Create the archive dir in the external storage - Mount the location on docker configuration file (Docker has permission to read write and execute everything, we are running it through root)</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/mnt/external_volume:/var/lib/postgresql/9.6/main/archive/</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="edit-pg_hbaconf--"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#edit-pg_hbaconf--" title="Direct link to heading">#</a>Edit pg_hba.conf -</h3><p>Add an entry to pg_hba.conf of the master to allow replication connections from the slave. The default location of pg_hba.conf is the data directory. However, you may modify the location of this file in the file  postgresql.conf. In Ubuntu/Debian, pg_hba.conf may be located in the same directory as the postgresql.conf file by default. You can get the location of postgresql.conf in Ubuntu/Debian by calling an OS command =&gt; pg_lsclusters.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Localhost</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">host    replication     replica          127.0.0.1/32             md5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># PostgreSQL Master IP address</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">host    replication     replica          10.0.15.10/32            md5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># PostgreSQL SLave IP address</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">host    replication     replica          10.0.15.11/32            md5</span></div></div></div></div></div><p>Save and exit, then restart PostgreSQL.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl restart postgresql</span></div></div></div></div></div><p>PostgreSQL is running under the IP address 10.0.15.10, check it with netstat command.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">netstat -plntu</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="slave--"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#slave--" title="Direct link to heading">#</a>Slave -</h2><p>Now that your master is ready, it’s time to configure the slave.</p><ul><li>Stop postgresql on the slave</li><li>Edit your postgresql.conf and pg_hba.conf and report the changes you made on the master (like this, your slave will have the same configuration and could act as a master) Edit your postgresql.conf and change this line :<code>hot_standby = on</code></li><li>Go to your PGDATA directory and delete all the files. WARNING : if the files postgresql.conf and pg_hba.conf are in this directory, you must backup them (same for the certificate files)</li><li>Now we will copy all the data from the master with the pg_basebackup command. You must run this command as the postgresql user (postgres on Debian, _postgresql on OpenBSD for example)</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="su---postgres"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#su---postgres" title="Direct link to heading">#</a>su - postgres</h3><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ pg_basebackup -h 172.17.0.2 -D /var/lib/postgresql/10/main/ -P -U replicate --wal-method=stream</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Password:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">23908/23908 kB (100%), 1/1 tablespace</span></div></div></div></div></div><p>Now, all your master’s data are copied on the slave. Now create a file recovery.conf in your PGDATA directory. Note - the recovery.conf is removed in version 12 onwards, for information see [this](<a href="https://www.postgresql.org/docs/12/release-12.html">https://www.postgresql.org/docs/12/release-12.html</a></p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">standby_mode          = &#x27;on&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">primary_conninfo      = &#x27;host=172.17.0.2 port=5432 user=replicate password=MySuperPassword&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">trigger_file = &#x27;/tmp/MasterNow&#x27;</span></div></div></div></div></div><p>Here is an explanation for each line :</p><ul><li><strong>standby_mode=on</strong> : specifies that the server must start as a standby server</li><li><strong>primary_conninfo</strong> : the parameters to use to connect to the master</li><li><strong>trigger_file</strong> : if this file exists, the server will stop the replication and act as a master</li><li><strong>restore_command</strong> : this command is only needed if you have used the archive_command on the master</li></ul><p>Start the postgresql server</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:55.777 UTC [8789] LOG:  listening on IPv4 address &quot;127.0.0.1&quot;, port 5432</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:55.777 UTC [8789] LOG:  could not bind IPv6 address &quot;::1&quot;: Cannot assign requested address</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:55.777 UTC [8789] HINT:  Is another postmaster already running on port 5432? If not, wait a few seconds and retry.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:55.786 UTC [8789] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:55.820 UTC [8790] LOG:  database system was interrupted; last known up at 2018-03-11 18:58:20 UTC</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:56.023 UTC [8790] LOG:  entering standby mode</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:56.034 UTC [8790] LOG:  redo starts at 0/4000028</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:56.039 UTC [8790] LOG:  consistent recovery state reached at 0/40000F8</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:56.040 UTC [8789] LOG:  database system is ready to accept read only connections</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-03-11 19:08:56.071 UTC [8794] LOG:  started streaming WAL from primary at 0/5000000 on timeline 1</span></div></div></div></div></div><p>You can see the replicate user on the master server :</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">postgres=# select * from pg_stat_activity  where usename = &#x27;replicate&#x27; ;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-[ RECORD 1 ]----+------------------------------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">datid            |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">datname          |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pid              | 9134</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">usesysid         | 16384</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">usename          | replicate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">application_name | walreceiver</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">client_addr      | 172.17.0.3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">client_hostname  |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">client_port      | 45234</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">backend_start    | 2018-03-11 19:08:56.049113+00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">xact_start       |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query_start      |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">state_change     | 2018-03-11 19:08:56.071363+00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">wait_event_type  | Activity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">wait_event       | WalSenderMain</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">state            | active</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">backend_xid      |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">backend_xmin     |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query            |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">backend_type     | walsender</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="storing-the-archive-files--"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#storing-the-archive-files--" title="Direct link to heading">#</a>Storing the archive files -</h2><ul><li>How to recreate database from the archive files?</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="references--"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#references--" title="Direct link to heading">#</a>References -</h2><ol><li><a href="https://www.percona.com/blog/2018/09/07/setting-up-streaming-replication-postgresql/">Setting up Streaming Replication Postgresql</a></li><li><a href="https://blog.raveland.org/post/postgresql_sr/">Postgresql Raveland blog</a></li><li><a href="https://www.howtoforge.com/tutorial/how-to-set-up-master-slave-replication-for-postgresql-96-on-ubuntu-1604/">How to set up master slave replication for postgresql</a></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="required-modifications"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#required-modifications" title="Direct link to heading">#</a>Required Modifications</h2><ol><li>Edit postgresql.conf section</li><li>Add the process for docker configuration</li><li>Take master and slave sample IP</li><li>Grammatical corrections.</li></ol></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/Samagra-Development/docs/edit/master/docs/PSQL Replication.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/docs/pLarge"><div class="pagination-nav__link--sublabel">Previous</div><div class="pagination-nav__link--label">« pLarge</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/docs/CODataAnalytics"><div class="pagination-nav__link--sublabel">Next</div><div class="pagination-nav__link--label">Data Analytics »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#understanding-replication-in-postgresql-upto-version-11" class="contents__link">Understanding replication in PostgreSQL (upto version 11)</a></li><li><a href="#firewall--" class="contents__link">Firewall -</a></li><li><a href="#setting-up-docker-using-external-volume" class="contents__link">Setting up Docker using external volume</a><ul><li><a href="#install-docker" class="contents__link">Install docker</a></li><li><a href="#setup-docker-engine" class="contents__link">Setup Docker engine</a></li><li><a href="#check-for-running-dockers" class="contents__link">Check for running dockers</a></li><li><a href="#view-all-available-dockers" class="contents__link">View all available dockers</a></li><li><a href="#enter-into-docker-shel" class="contents__link">Enter into Docker shel</a></li></ul></li><li><a href="#master--" class="contents__link">Master -</a><ul><li><a href="#edit-postgresqlconf--" class="contents__link">Edit postgresql.conf -</a></li><li><a href="#edit-pg_hbaconf--" class="contents__link">Edit pg_hba.conf -</a></li></ul></li><li><a href="#slave--" class="contents__link">Slave -</a><ul><li><a href="#su---postgres" class="contents__link">su - postgres</a></li></ul></li><li><a href="#storing-the-archive-files--" class="contents__link">Storing the archive files -</a></li><li><a href="#references--" class="contents__link">References -</a></li><li><a href="#required-modifications" class="contents__link">Required Modifications</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div>Samagra Development Associates Pvt. Ltd | 2020 | Built with Docusaurus</div></div></div></footer>
</div>

<script src="/docs/styles.1167a1dc.js"></script>

<script src="/docs/runtime~main.26a0ac09.js"></script>

<script src="/docs/main.02026a88.js"></script>

<script src="/docs/1.66947721.js"></script>

<script src="/docs/2.685e1460.js"></script>

<script src="/docs/3.a41b11c8.js"></script>

<script src="/docs/1be78505.8b70ae36.js"></script>

<script src="/docs/64f9f2ab.c376201c.js"></script>

<script src="/docs/17896441.15136d0f.js"></script>

<script src="/docs/3db494a0.c9040c91.js"></script>


</body>
</html>